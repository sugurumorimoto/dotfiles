#
# Prefix: C-j (Ctrl+j instead of default Ctrl+b)
#
set -g  prefix C-j
unbind C-b

# Terminal settings
set -g  default-terminal "xterm-256color"  # Enable 256 color support
set -ga terminal-overrides ",$TERM:Tc"     # Enable true color support
set -g  default-shell /bin/zsh             # Set default shell to zsh
set-option -g default-shell /bin/zsh

# General settings
set -g  history-limit 10000  # Scrollback buffer size
set -g  escape-time 10       # Reduce escape key delay
set -g  base-index 1         # Start window numbering at 1
set -g  pane-base-index 1    # Start pane numbering at 1

# Status bar
set -g status-style fg="colour251",bg="colour236"
set -g status-left-length 32
set -g status-left  "#[fg=colour0,bg=colour4] \uf009 #(basename -- #S) #[fg=colour4,bg=default]\ue0b0#[default] "
set -g status-right "#[fg=colour238]\ue0b2#[fg=colour251,bg=colour238] \uf073 %Y/%m/%d #[fg=colour245]\ue0b3#[fg=colour147] \ue384 %H:%M:%S #[fg=colour245]\ue0b3#[fg=colour79] \uf878 #h #[default]"
set -g window-status-format "#[fg=colour236,bg=colour244]\ue0b0#[fg=colour0] #I #[fg=colour244,bg=colour238]\ue0b0#[fg=default] #W #[fg=colour238,bg=default]\ue0b0#[default]"
set -g window-status-current-format "#[fg=colour236,bg=colour2]\ue0b0#[fg=colour0] #I #[fg=colour2,bg=colour238]\ue0b0#[fg=default] #W #[fg=colour238,bg=default]\ue0b0#[default]"
set -g window-style "bg=colour236"
set -g window-active-style "bg=terminal"

# Status bar position and refresh interval
set -g status-position top
set -g status-interval 1

# Pane border
set -g pane-border-status top
set -g pane-border-lines single
set -g pane-border-format "#("$XDG_CONFIG_HOME/tmux/pane-border-format.bash")"

# Enable mouse control
set -g mouse on

# Use vi key bindings in copy mode
set-window-option -g mode-keys vi
unbind-key -T copy-mode-vi MouseDragEnd1Pane

# Key bindings
# Reload configuration
bind r source-file "$XDG_CONFIG_HOME/tmux/tmux.conf" \; display "config reloaded"

# Window splitting (preserves current path)
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Window management
bind C-w kill-window
bind -r n next-window
bind -r p previous-window

# Pane navigation (vi-like keys)
bind -r h select-pane -L
bind -r j select-pane -D
bind -r k select-pane -U
bind -r l select-pane -R

# Pane resizing (5 cells at a time)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Search patterns in copy mode
bind / copy-mode \; command-prompt -p "(search down)" "send -X search-forward \"%%%\""
bind C-u copy-mode \; send -X search-forward "(https?://|git@|git://|ssh://|ftp://|file:///)[[:alnum:]?=%/_.:,;~@!#$&()*+-]*"
bind C-i copy-mode \; send -X search-forward "[[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]]{1,3}\.[[:digit:]]{1,3}"

# Popup window (Ctrl+j g for lazygit)
bind g popup -w90% -h90% -E lazygit

# TPM (Tmux Plugin Manager)
setenv -g TMUX_PLUGIN_MANAGER_PATH "$XDG_DATA_HOME/tmux/plugins"
set -g @tpm-install I
set -g @tpm-update u
set -g @tpm-clean U
set -g @plugin 'tmux-plugins/tpm'

# Tmux-yank: Copy to system clipboard
set -g @plugin 'tmux-plugins/tmux-yank'

# Tmux-open: Open files and URLs from tmux
set -g @open 'o'
set -g @open-editor 'e'
set -g @plugin 'tmux-plugins/tmux-open'

# Tmux-resurrect and tmux-continuum: Session persistence
# - Continuous saving of tmux environment
# - Automatic tmux start when computer/server is turned on
# - Automatic restore when tmux is started
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

# Enable pane content capture
set -g @resurrect-capture-pane-contents 'on'

# Enable automatic restore on tmux startup
set -g @continuum-restore 'on'

# Save session every 5 minutes
set -g @continuum-save-interval '5'

# Copy mode settings
unbind -T copy-mode MouseDragEnd1Pane
unbind -T copy-mode-vi MouseDragEnd1Pane
bind-key -T copy-mode C-c send-keys -X copy-pipe-and-cancel "xsel -bi"
bind-key -T copy-mode-vi C-c send-keys -X copy-pipe-and-cancel "xsel -bi"

# Initialize TPM (install if not present)
if 'test ! -d "$TMUX_PLUGIN_MANAGER_PATH/tpm"' \
   'run "git clone https://github.com/tmux-plugins/tpm "$TMUX_PLUGIN_MANAGER_PATH/tpm" && echo "$TMUX_PLUGIN_MANAGER_PATH/tpm/bin/install_plugins"'
run "$TMUX_PLUGIN_MANAGER_PATH/tpm/tpm"

# Auto-layout: Split new sessions into 4-pane IDE layout
# Layout: 1 large pane on top (70%), 3 smaller panes on bottom (split into 3 equal parts)
set-hook -g after-new-session 'run-shell "tmux split-window -v -l 70%; \
  tmux select-pane -t 1; \
  tmux split-window -h -l 66%; \
  tmux split-window -h -l 50%; \
  tmux select-pane -t 0"'