: 1712411485:0;which zinit
: 1712411485:0;bash /Users/morimotosuguru/dotfiles/scripts/setup-links.bash
: 1712411485:0;...
: 1712411485:0;reload
: 1712411485:0;source .zprofile
: 1712411485:0;source .zshenv
: 1712411485:0;source .zshrc
: 1712411485:0;echo $path
: 1712411485:0;echo $PATH
: 1712411485:0;echo $VSCODE_ZDOTDIR
: 1712411485:0;eval $(/opt/homebrew/bin/brew shellenv)
: 1712411485:0;which brew
: 1712411485:0;echo $ZOTDIR
: 1712411485:0;echo $ZDOTDIR
: 1712411485:0;echo $USER_ZDOTDIR
: 1712411485:0;-f $USER_ZDOTDIR/.zlogin
: 1712411485:0;$USER_ZDOTDIR/.zlogin
: 1712411485:0;. $USER_ZDOTDIR/.zprofile
: 1712411485:0;for i in $(seq 1 10); do time zsh -i -c exit > /dev/null ; done
: 1712411485:0;exec /opt/homebrew/bin/zsh -l
: 1712411485:0;echo $HISTFILE
: 1712411485:0;history
: 1712411485:0;whence -p doctor
: 1712411485:0;today
: 1712411485:0;import sklearn.datasets as d\
import numpy as np\
import matplotlib as plt\
\
reg_data = d.make_regression()\
complex_reg_data = d.make_regression(1000, 10, 5, 2, 1.0)\
\
blobls_data, blobs_target = d.make_blobs()\
\

: 1712411485:0;source /Users/morimotosuguru/.anyenv/envs/pyenv/shims/activate
: 1712411485:0;/opt/homebrew/Caskroom/chromedriver/105.0.5195.52/chromedriver ; exit;
: 1712411485:0;node -e 'require("fs").writeFileSync("/Users/morimotosuguru/Library/Application Support/vscode-sqltools/.node-runtime", process.execPath)' && exit 0
: 1712411485:0;source /Users/morimotosuguru/.anyenv/envs/pyenv/versions/miniforge3-4.9.2/bin/activate base
: 1712411485:0;python '/Users/morimotosuguru/Dropbox/user_morimoto/script/python/atcoder/initit.py' paiza_S049
: 1712411485:0;/opt/homebrew/Caskroom/chromedriver/108.0.5359.71/chromedriver ; exit;
: 1712411485:0;/opt/homebrew/Caskroom/chromedriver/111.0.5563.64/chromedriver ; exit;
: 1712411485:0;/opt/homebrew/Caskroom/chromedriver/113.0.5672.63/chromedriver ; exit;
: 1712411485:0;/Users/morimotosuguru/Downloads/moirai20140528/install_MOIRAI_for_MACOSX.command ; exit;
: 1712411485:0;whence -p exa
: 1712411485:0;/Users/morimotosuguru/Dropbox/Brewfile ; exit;
: 1712411411:0;anyenv
: 1712411420:0;anyenv install -list
: 1712411426:0;anyenv install -h
: 1712411431:0;anyenv install -l
: 1712411467:0;anyenv install --init
: 1712411478:0;anyenv install pyenv
: 1712411561:0;pyenv -l
: 1712411635:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | grep music
: 1712411681:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | sed -n 's/music//'
: 1712411692:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | sed 's/music//'
: 1712411702:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | sed '/music/d'
: 1712411750:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | sed '/music/d' > /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh
: 1712411804:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh | sed '/music/d' > temp
: 1712411817:0;mv temp /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh
: 1712411937:0;cat /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh
: 1712411964:0;vim /Users/morimotosuguru/.local/share/zinit/snippets/OMZ::plugins--macos/macos.plugin.zsh/macos.plugin.zsh
: 1712412038:0;brew-file install
: 1712412261:0;cask google-chrome
: 1712412863:0;find / -name ".DS_Store"
: 1712412899:0;fd . | rg .DS_store
: 1712413160:0;pyenv
: 1712413168:0;pyenv install -l
: 1712413207:0;pyenv install miniforge3-23.11.0-0
: 1712413303:0;python
: 1712413327:0;touch /Users/morimotosuguru/.config/python/startup.py
: 1712413346:0;touch -p /Users/morimotosuguru/.config/python/startup.py
: 1712413376:0;exa -a .config
: 1712415683:0;whence -p pip
: 1712415704:0;pip
: 1712415716:0;pip -h
: 1712415729:0;pyenv -h
: 1712415740:0;pyenv -version
: 1712415742:0;pyenv -versions
: 1712415748:0;pyenv versions
: 1712415770:0;pyenv global miniforge3-23.11.0-0
: 1712415774:0;whence -p python
: 1712415780:0;pip install radian
: 1712463885:0;mv Miniconda3-latest-MacOSX-x86_64.sh start_miniconda3.sh
: 1712463935:0;mv start_miniconda3.sh .start_miniconda3.sh
: 1712464810:0;
: 1712464056:0;/Users/morimotosuguru/start_miniconda3.sh
: 1712464062:0;bash /Users/morimotosuguru/start_miniconda3.sh
: 1712464745:0;touch .start_miniconda3.sh
: 1712464770:0;vim .start_miniconda3.sh
: 1712464810:0;exec /bin/zsh -l
: 1712464882:0;/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"\

: 1712465155:0;fd . | rg
: 1712465172:0;sudo figr .DS_Store
: 1712465189:0;figr .DS_Store
: 1712465265:0;fd . | rg .DS_store | rm
: 1712465312:0;sudo find / -name .DS_Store -delete; killall Finder
: 1712466671:0;sudo fd . | rg .DS_store
: 1712467057:0;conda config --add channels conda-forge
: 1712467063:0;conda config --add channels defaults
: 1712467069:0;conda config --add channels r
: 1712467075:0;conda config --add channels bioconda
: 1712467088:0;conda install samtools
: 1712467126:0;whence -p bedtools
: 1712467148:0;conda install bedGraphToBigWig
: 1712467687:0;conda install ucsc-bedgraphtobigwig
: 1712467915:0;/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/GRCh38.primary_assembly.chrom.sizes;2A
: 1712467951:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/4_CAGE_Read1_CTSS_221114.sh
: 1712469442:0;conda install trimmomatic
: 1712469601:0;whence -p trimmomatic
: 1712469624:0;find -name trimmomatic-0.39
: 1712469631:0;find ./ -name trimmomatic-0.39
: 1712469694:0;exa -a /Users/morimotosuguru/miniconda3/
: 1712469703:0;exa -a /Users/morimotosuguru/miniconda3/envs
: 1712469710:0;exa -a /Users/morimotosuguru/miniconda3/lib
: 1712469722:0;exa -a /Users/morimotosuguru/miniconda3
: 1712469759:0;tree
: 1712469769:0;tree | grep tri
: 1712469789:0;tree | grep trimmomatic-0.39-2
: 1712469815:0;tree | grep trimmomatic.jar
: 1712469836:0;find . -name trimmomatic-0.39
: 1712469844:0;find . -name trimmomatic
: 1712469848:0;find . -name trimmomatic.jar
: 1712469866:0;realpath ./share/trimmomatic-0.39-2/trimmomatic.jar
: 1712470415:0;conda env create RNAseq
: 1712470527:0;ld
: 1712470654:0;c
: 1712470666:0;conda env list
: 1712470937:0;conda env create -f environment.yml
: 1712471150:0;conda install star
: 1712471230:0;conda env
: 1712471238:0;conda env config
: 1712471285:0;touch environment.yml
: 1712471291:0;conda env create -n RNAseq
: 1712471511:0;conda create -n $project_name
: 1712471522:0;conda create -n RNAseq
: 1712471565:0;conda activate RNAseq
: 1712471573:0;conda install -c bioconda star
: 1712471614:0;# Install trimmomatic\
conda install trimmomatic
: 1712472683:0;rRNA=/Users/morimotosuguru/Library/CloudStorage/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_U13369.1_5S_rDNA\
genome=/Users/morimotosuguru/Library/CloudStorage/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_GENCODEv45_GRCh38PRI\
IntegerT=4\
IntegerM=20\
PathTrimmomatic=/Users/morimotosuguru/miniconda3/envs/RNAseq/share/trimmomatic-0.39-2\
export PATH=$PATH:/Users/morimotosuguru/miniconda3/bin:/Users/morimotosuguru/miniconda3/envs/RNAseq/bin
: 1712472723:0;for infile in *_R1_001_trimmed.fastq.gz\
  do base=$(basename "${infile}" _R1_001_trimmed.fastq.gz)\
  echo "${infile}"\
  echo "${base}"\
\
  star \\
  --runThreadN "${IntegerT}" \\
  --genomeDir "${rRNA}" \\
  --readFilesIn "${base}_R1_001_trimmed.fastq.gz" "${base}_R2_001_trimmed.fastq.gz" \\
  --readFilesCommand gunzip -c \\
  --outFilterMultimapNmax "${IntegerM}" \\
  --outReadsUnmapped Fastx \\
  --outFilterMismatchNmax 10 \\
  --outSAMtype BAM Unsorted \\
  --outFileNamePrefix "${base}"\
  done
: 1712472817:0;echo "${rRNA}"
: 1712472913:0;exa -a /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_U13369.1_5S_rDNA
: 1712472930:0;exa -alhg --group-directories-first --git --time-style long-iso /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_U13369.1_5S_rDNA
: 1712472982:0;\
for infile in *_R1_001_trimmed.fastq.gz\
  do base=$(basename "${infile}" _R1_001_trimmed.fastq.gz)\
  echo "${infile}"\
  echo "${base}"\
\
  star \\
  --runThreadN "${IntegerT}" \\
  --genomeDir "$rRNA" \\
  --readFilesIn "${base}_R1_001_trimmed.fastq.gz" "${base}_R2_001_trimmed.fastq.gz" \\
  --readFilesCommand gunzip -c \\
  --outFilterMultimapNmax "${IntegerM}" \\
  --outReadsUnmapped Fastx \\
  --outFilterMismatchNmax 10 \\
  --outSAMtype BAM Unsorted \\
  --outFileNamePrefix "${base}"\
  done
: 1712473013:0;echo "$rRNA"
: 1712473156:0;chmod /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_U13369.1_5S_rDNA/genomeParameters.txt 777
: 1712473166:0;sudo chmod /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/STARindex_U13369.1_5S_rDNA/genomeParameters.txt 777
: 1712473179:0;chmod -h
: 1712473296:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/2_CAGE_PairedEnd_Mapping_v2_230622.sh
: 1712487156:0;l
: 1712487168:0;cd　/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/test/Trimmed/ForAlignment/BamFiles/MappedUniq/Read1Uniq/BigWig/RAWbw
: 1712487319:0;fd . | rg bigWigAverageOverBed
: 1712487388:0;conda install ucsc-bigwigaverageoverbed
: 1712487442:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/5.1_CAGE_CTSS_BW_Recounts_promoter_221113.sh -p /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/hg38_fair+new_CAGE_peaks_phase1and2.6.bed
: 1712487500:0;export PATH=$PATH:/Users/morimotosuguru/miniconda3/bin
: 1712487504:0;whence -p conda
: 1712487907:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/5.2_CAGE_CTSS_BW_Recounts_enhancer_221113.sh -e /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/Supplementary_Data_1_Human_FANTOM-NET_enhancers.hg38.6.bed
: 1712490757:0;cd　/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main
: 1712490790:0;bin
: 1712490858:0;wget https://github.com/anderssonrobin/enhancers/tree/master/bin
: 1712490889:0;wget https://github.com/anderssonrobin/enhancers/tree/master/bin/
: 1712490965:0;git pull https://github.com/anderssonrobin/enhancers/tree/master/bi
: 1712491022:0;wget git@github.com:anderssonrobin/enhancers.git
: 1712491099:0;curl https://github.com/anderssonrobin/enhancers.git
: 1712492044:0;touch bed.list
: 1712492111:0;echo /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/test/Trimmed/ForAlignment/BamFiles/MappedUniq/Read1Uniq/BED/r132_5m_3_S99_compressedUnmapped.out_Aligned.sortedByCoord.out.uniqmapped.Read1.bed >> bed.list
: 1712492121:0;cat bed.list
: 1712492132:0;head bed.list
: 1712492147:0;realpath bed.list
: 1712492256:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/6_fixed_bidir_enhancers_10bp.sh
: 1712492264:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/6_fixed_bidir_enhancers_10bp.sh -f bed.list
: 1712492457:0;source /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/6_fixed_bidir_enhancers_10bp.sh -f bed.list
: 1712492540:0;mv bed.list bed.txt
: 1712492551:0;FILES=bed.txt
: 1712492558:0;STUB="test"          # Name of project (prefix to output files)\
OPATH="CAGE_pipeline-main/test/Trimmed/ForAlignment/BamFiles/MappedUniq/Read1Uniq"         # Path where to put the output files\
FILTER="/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/Noheader_gencode.v45.chr.gene.transcript.nonlncRNA600.mask.6.bed"        # Bed file with masked regions for negative filtering of bidirectional loci (e.g. known TSSs +/- 500bp and known exons +/- 200 bp)\
TEMP="/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/test/Trimmed/ForAlignment/BamFiles/MappedUniq/Read1Uniq/BigWig/RAWbw/Enhancer_call"          # Temporary directory to use\
DIST=400         # Maximum distance between divergent tag clusters to be considered the same bidirectional loci (default 400)\
WIN=200          # Size of flanking windows around mid points to consider when quantifying the expression of bidirectional transcribed loci (default 200)\
DIR=0.8          # Directionality threshold in (0,1) for filtering enhancers (default 0.8)\
RMTMP=1
: 1712492707:0;## Add slash to output and temp paths if needed\
if  [[ ! $OPATH == */ ]]; then\
	OPATH=${OPATH}/\
fi\
if  [[ ! $TEMP == */ ]]; then\
	TEMP=${TEMP}/\
fi
: 1712492730:0;TCFILE=${TEMP}${STUB}TCs.bed
: 1712492794:0;if [ "$TCS" == "" ]; then\
	echoerr "Identifying tag clusters"\
	BED=${TEMP}${STUB}pooled.bed\
	MBED=${TEMP}${STUB}pooled.merged.bed\
	if [ -e $BED ]; then rm $BED; fi\
	touch $BED\
	for FILE in $( cat $FILES ); do cat $FILE >> $BED; done\
	sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -k 3,3n -k 6,6 $BED | bedtools groupby -i stdin -g 1,2,3,6 -c 5 -o sum | awk 'BEGIN{OFS="\t"}{print $1, $2, $3, NR, $5, $4}' > $MBED\
	bedtools merge -d 10 -s -c 5,6 -o sum,distinct -i $MBED | awk 'BEGIN{OFS="\t"}{if ($4 > 0) {print $1, $2, $3, $1 ":" $2 "-" $3 "," $5, $4, $5}}' | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n > ${OPATH}${STUB}TCs.bed\
	TCFILE=${OPATH}${STUB}TCs.bed\
fi\

: 1712492824:0;$TCS
: 1712492833:0;TCS=""
: 1712492835:0;echo $TCS
: 1712492858:0;if [ "$TCS" == "" ]; then\
	echoerr "Identifying tag clusters"\
	BED=${TEMP}${STUB}pooled.bed\
	MBED=${TEMP}${STUB}pooled.merged.bed\
	if [ -e $BED ]; then rm $BED; fi\
	touch $BED\
	for FILE in $( cat $FILES ); do cat $FILE >> $BED; done\
	sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -k 3,3n -k 6,6 $BED | bedtools groupby -i stdin -g 1,2,3,6 -c 5 -o sum | awk 'BEGIN{OFS="\t"}{print $1, $2, $3, NR, $5, $4}' > $MBED\
	bedtools merge -d 10 -s -c 5,6 -o sum,distinct -i $MBED | awk 'BEGIN{OFS="\t"}{if ($4 > 0) {print $1, $2, $3, $1 ":" $2 "-" $3 "," $5, $4, $5}}' | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n > ${OPATH}${STUB}TCs.bed\
	TCFILE=${OPATH}${STUB}TCs.bed\
fi
: 1712492870:0;\
## Identify tag clusters, if needed\
## Note: The Andersson et al. (2014) study used DPI tag clusters described in Forrest A et al. 2014. Nature. (doi:10.1038/nature13182).\
if [ "$TCS" == "" ]; then\
	echoerr "Identifying tag clusters"\
	BED=${TEMP}${STUB}pooled.bed\
	MBED=${TEMP}${STUB}pooled.merged.bed\
	if [ -e $BED ]; then rm $BED; fi\
	touch $BED\
	for FILE in $( cat $FILES ); do cat $FILE >> $BED; done\
	sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -k 3,3n -k 6,6 $BED | bedtools groupby -i stdin -g 1,2,3,6 -c 5 -o sum | awk 'BEGIN{OFS="\t"}{print $1, $2, $3, NR, $5, $4}' > $MBED\
	bedtools merge -d 10 -s -c 5,6 -o sum,distinct -i $MBED | awk 'BEGIN{OFS="\t"}{if ($4 > 0) {print $1, $2, $3, $1 ":" $2 "-" $3 "," $5, $4, $5}}' | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n > ${OPATH}${STUB}TCs.bed\
	TCFILE=${OPATH}${STUB}TCs.bed\
fi\

: 1712492879:0;echoerr "Identifying tag clusters"
: 1712492884:0;BED=${TEMP}${STUB}pooled.bed
: 1712492889:0;echo $BED
: 1712492896:0;MBED=${TEMP}${STUB}pooled.merged.bed
: 1712492933:0;if [ -e $BED ]; then rm $BED; fi
: 1712492938:0;touch $BED
: 1712492947:0;for FILE in $( cat $FILES ); do cat $FILE >> $BED; done
: 1712492967:0;sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -k 3,3n -k 6,6 $BED | bedtools groupby -i stdin -g 1,2,3,6 -c 5 -o sum | awk 'BEGIN{OFS="\t"}{print $1, $2, $3, NR, $5, $4}' > $MBED
: 1712493129:0;OPATH="/Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/test/Trimmed/ForAlignment/BamFiles/MappedUniq/Read1Uniq"
: 1712493134:0;bedtools merge -d 10 -s -c 5,6 -o sum,distinct -i $MBED | awk 'BEGIN{OFS="\t"}{if ($4 > 0) {print $1, $2, $3, $1 ":" $2 "-" $3 "," $5, $4, $5}}' | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n > ${OPATH}${STUB}TCs.bed
: 1712493152:0;TCFILE=${OPATH}${STUB}TCs.bed
: 1712493165:0;## Identify bidirectional transcribed loci\
echoerr "Identifying bidirectionally transcribed loci"\
${BINDIR}/split_strand.pl $TCFILE ${TEMP}${STUB}TCs.plus.bed ${TEMP}${STUB}TCs.minus.bed
: 1712493175:0;bedtools intersect -v -wa -a ${TEMP}${STUB}TCs.plus.bed -b ${TEMP}${STUB}TCs.minus.bed > ${TEMP}${STUB}TCs.plus.no.minus.bed\
bedtools intersect -v -wa -b ${TEMP}${STUB}TCs.plus.bed -a ${TEMP}${STUB}TCs.minus.bed > ${TEMP}${STUB}TCs.minus.no.plus.bed\
bedtools window -l 0 -r $DIST -a ${TEMP}${STUB}TCs.minus.no.plus.bed -b ${TEMP}${STUB}TCs.plus.no.minus.bed | awk 'BEGIN{OFS="\t"}{print $0, $3-$8}' > ${TEMP}${STUB}TCs.bidir.pairs.bed\
sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -o ${TEMP}${STUB}TCs.bidir.pairs.bed ${TEMP}${STUB}TCs.bidir.pairs.bed\
## Merge pairs and discard bidirectional transcribed loci too close to chromosome starts\

: 1712493185:0;## Merge pairs and discard bidirectional transcribed loci too close to chromosome starts\
${BINDIR}/bed12_merge_pairs_dynamic.pl ${TEMP}${STUB}TCs.bidir.pairs.bed | awk -v win=$WIN 'BEGIN{OFS="\t"}{if (($7-win) >= 0) {print $1, $2, $3, $1 ":" $2 "-" $3, $5, $6, $7, $8, $9, $10, $11, $12}}' > ${OPATH}${STUB}bidir.pairs.bed\
\
BPS=${OPATH}${STUB}bidir.pairs.bed
: 1712493218:0;## Filter for known TSSs and exons\
if [ "$FILTER" != "" ]; then\
	echoerr "Filtering masked regions"\
	bedtools intersect -v -wa -a ${OPATH}${STUB}bidir.pairs.bed -b $FILTER > ${OPATH}${STUB}bidir.pairs.filtered.bed\
	sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n -o ${OPATH}${STUB}bidir.pairs.filtered.bed ${OPATH}${STUB}bidir.pairs.filtered.bed\
	BPS=${OPATH}${STUB}bidir.pairs.filtered.bed\
fi\
\
ESTUB=$( echo $BPS | sed -e "s/\.bed//" )\
ESTUB=`basename $ESTUB`\
\
## Quantify expression\
echoerr "Quantifying expression across files"\
awk -v win=$WIN 'BEGIN{OFS="\t"}{print $1,$7-win,$7,$4,".","-"}' $BPS > ${TEMP}${ESTUB}.left.minus.window.bed\
awk -v win=$WIN 'BEGIN{OFS="\t"}{print $1,$8,$8+win,$4,".","-"}' $BPS > ${TEMP}${ESTUB}.right.minus.window.bed\
awk -v win=$WIN 'BEGIN{OFS="\t"}{print $1,$7-win,$7,$4,".","+"}' $BPS > ${TEMP}${ESTUB}.left.plus.window.bed\
awk -v win=$WIN 'BEGIN{OFS="\t"}{print $1,$8,$8+win,$4,".","+"}' $BPS > ${TEMP}${ESTUB}.right.plus.window.bed\
\
cut -f 4 ${TEMP}${ESTUB}.left.minus.window.bed > ${TEMP}${ESTUB}.expression.left.minus.matrix\
cut -f 4 ${TEMP}${ESTUB}.right.minus.window.bed > ${TEMP}${ESTUB}.expression.right.minus.matrix\
cut -f 4 ${TEMP}${ESTUB}.left.plus.window.bed > ${TEMP}${ESTUB}.expression.left.plus.matrix\
cut -f 4 ${TEMP}${ESTUB}.right.plus.window.bed > ${TEMP}${ESTUB}.expression.right.plus.matrix\

: 1712493235:0;LIBRARYCOUNTS=${OPATH}${STUB}library.counts.txt\
if [ -e $LIBRARYCOUNTS ]; then rm $LIBRARYCOUNTS; fi\
touch $LIBRARYCOUNTS\
\
for FILE in $( cat $FILES ); do\
	CNT=`awk '{SUM += $5} END {print SUM}' $FILE`\
	echo $CNT >> $LIBRARYCOUNTS\
	for SIDE in left right; do\
		for STRAND in plus minus; do\
			bedtools intersect -wao -s -a ${TEMP}${ESTUB}.${SIDE}.${STRAND}.window.bed -b $FILE | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n | cut -f 1,2,3,4,5,6,11 | awk 'BEGIN{OFS="\t"} {v = $7; if (v <= 0) v = 0; print $1,$2,$3,$4,$5,$6,v}' | bedtools groupby -g 1,2,3,4,5,6 -c 7 -o sum | sort --temporary-directory=${TEMP} -k 1,1 -k 2,2n | cut -f 7 > ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tmp &\
		done\
		wait\
		for STRAND in plus minus; do\
			paste ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.matrix ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tmp > ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tmp2\
			mv ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tmp2 ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.matrix\
		done\
	done\
done\
rm ${TEMP}${ESTUB}.expression.left.plus.tmp\
rm ${TEMP}${ESTUB}.expression.left.minus.tmp\
rm ${TEMP}${ESTUB}.expression.right.plus.tmp\
rm ${TEMP}${ESTUB}.expression.right.minus.tmp\
\
${BINDIR}/sum_matrices.pl ${TEMP}${ESTUB}.expression.left.minus.matrix ${TEMP}${ESTUB}.expression.right.plus.matrix 1 | paste $BPS - | cut -f 4,13- > ${OPATH}${ESTUB}.expression.matrix\
\
## TPM normalize\
echoerr "Normalizing expression to tags per million mapped tags (TPM)"\
${BINDIR}/tpm_transform.pl ${OPATH}${ESTUB}.expression.matrix ${LIBRARYCOUNTS} 1 | paste $BPS - | cut -f 4,13- > ${OPATH}${ESTUB}.expression.tpm.matrix\
\
## TPM normalize each strand separately\
for STRAND in minus plus; do\
	for SIDE in left right; do\
		${BINDIR}/tpm_transform.pl ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.matrix ${LIBRARYCOUNTS} 1 | paste $BPS - | cut -f 4,13- > ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tpm.matrix\
	done\
done\
\
## Calculate directionality scores\
echoerr "Calculating directionality scores"\
for STRAND in minus plus; do\
	for SIDE in left right; do\
		awk '{s=0; for (i=2; i<=NF; i++) {if ($i != "NA") s+=$i}; print s}' ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tpm.matrix > ${TEMP}${ESTUB}.expression.${SIDE}.${STRAND}.tpm.sum\
	done\
done\
paste ${TEMP}${ESTUB}.expression.right.plus.tpm.sum ${TEMP}${ESTUB}.expression.left.minus.tpm.sum | awk '{print ($1 == "NA" || ($1+$2 == 0)) ? "NA" : ($1-$2) / ($1+$2)}' | paste $BPS - | cut -f 4,13 > ${OPATH}${ESTUB}.directionality.txt\
paste ${TEMP}${ESTUB}.expression.left.plus.tpm.sum ${TEMP}${ESTUB}.expression.left.minus.tpm.sum | awk '{print ($1 == "NA" || $2 == 0) ? "NA" : $1 / $2}' | paste $BPS - | cut -f 4,13 > ${TEMP}${ESTUB}.left.plus.fraction.txt\
paste ${TEMP}${ESTUB}.expression.right.minus.tpm.sum ${TEMP}${ESTUB}.expression.right.plus.tpm.sum | awk '{print ($1 == "NA" || $2 == 0) ? "NA" : $1 / $2}' | paste $BPS - | cut -f 4,13 > ${TEMP}${ESTUB}.right.minus.fraction.txt\
\
## Calculate directionality matrix\
${BINDIR}/matrix_directionality.pl ${TEMP}${ESTUB}.expression.right.plus.tpm.matrix ${TEMP}${ESTUB}.expression.left.minus.tpm.matrix 1 | paste $BPS - | cut -f 4,13- > ${OPATH}${ESTUB}.directionality.matrix\
\
## Check if bidirectionally transcribed in at least one sample\
${BINDIR}/matrix_bidirectional_transcribed.pl ${TEMP}${ESTUB}.expression.left.minus.matrix ${TEMP}${ESTUB}.expression.right.plus.matrix 1 > ${TEMP}${ESTUB}.bidir.transcribed.txt\
\
## Enhancer prediction\
echoerr "Predicting enhancers"\
cut -f 2 ${TEMP}${ESTUB}.left.plus.fraction.txt > ${TEMP}${ESTUB}.lp.txt\
cut -f 2 ${TEMP}${ESTUB}.right.minus.fraction.txt > ${TEMP}${ESTUB}.rm.txt\
cut -f 2 ${OPATH}${ESTUB}.directionality.txt > ${TEMP}${ESTUB}.wdir.txt\
paste $BPS ${TEMP}${ESTUB}.lp.txt ${TEMP}${ESTUB}.rm.txt ${TEMP}${ESTUB}.wdir.txt ${TEMP}${ESTUB}.bidir.transcribed.txt | awk -v dir=$DIR '{if ($13 < 1 && $14 < 1 && $15 < dir && $15 > (-1*dir) && $16 == 1) print $0}' | cut -f -12 > ${OPATH}${STUB}enhancers.bed\
\
sort --temporary-directory=${TEMP} -k 4,4 -o $BPS $BPS\
sort --temporary-directory=${TEMP} -k 1,1 -o ${OPATH}${ESTUB}.expression.matrix ${OPATH}${ESTUB}.expression.matrix\
sort --temporary-directory=${TEMP} -k 1,1 -o ${OPATH}${ESTUB}.expression.tpm.matrix ${OPATH}${ESTUB}.expression.tpm.matrix\
sort --temporary-directory=${TEMP} -k 1,1 -o ${OPATH}${ESTUB}.directionality.txt ${OPATH}${ESTUB}.directionality.txt\
sort --temporary-directory=${TEMP} -k 1,1 -o ${OPATH}${ESTUB}.directionality.matrix ${OPATH}${ESTUB}.directionality.matrix\
sort --temporary-directory=${TEMP} -k 4,4 -o ${OPATH}${STUB}enhancers.bed ${OPATH}${STUB}enhancers.bed\
cut -f 4 ${OPATH}${STUB}enhancers.bed | join -1 1 -2 1 - ${OPATH}${ESTUB}.expression.matrix | tr " " "\t" > ${OPATH}${STUB}enhancer.expression.matrix\
cut -f 4 ${OPATH}${STUB}enhancers.bed | join -1 1 -2 1 - ${OPATH}${ESTUB}.expression.tpm.matrix | tr " " "\t" > ${OPATH}${STUB}enhancer.expression.tpm.matrix\
\
if [ $RMTMP -eq 1 ]; then rm -rf $TEMP; fi\

: 1712496959:0;exa -a bed.txt
: 1712496975:0;vim bed.txt
: 1712497052:0;bash /Users/morimotosuguru/Dropbox/user_morimoto/script/analysis/CAGE_pipeline-main/bin/6_fixed_bidir_enhancers_10bp.sh -f bed.txt
: 1712502557:0;crontab -e
: 1712502630:0;exa -a
: 1712502633:0;realpath Library/CloudStorage/Dropbox/user_morimoto/script/python/webScraping/scribe_all.sh
: 1712502641:0;realpath /Library/CloudStorage/Dropbox/user_morimoto/script/python/webScraping/scribe_all.sh
: 1712502649:0;fd . | rg scribe_all.sh
: 1712502690:0;whence -p zsh
: 1712502724:0;crontab -l
: 1712564241:0;git -h
: 1712564253:0;git pull
: 1712575231:0;realpath Dropbox/user_morimoto/script/python/webScraping/scribe_all.sh
: 1712575257:0;pip install selenium
: 1712575264:0;/Users/morimotosuguru/Dropbox/user_morimoto/script/python/webScraping/scribe_all.sh\

: 1712587985:0;mass list
: 1712588000:0;mas search
: 1712588009:0;mas -help
: 1712588011:0;mas -h
: 1712588016:0;mas --h
: 1712588018:0;mas
: 1712588023:0;mas list
: 1712595546:0;git config --global user.name sugurumorimoto
: 1712595624:0;git config --global user.email woodwood0809@icloud.com
: 1712595863:0;ln -sfv "$XDG_CONFIG_HOME/git/template/commit-template.txt" "$HOME/.git/commit-template.txt"
: 1712595903:0;exa -a
: 1712595962:0;if [ ! -d "$HOME/.git" ]; then\
    mkdir -p "$HOME/.git"\
    chmod 700 "$HOME/.git"\
fi
: 1712595971:0;ln -sfv "$XDG_CONFIG_HOME/git/template/commit-template.txt" "$HOME/.git/commit-template.txt"
: 1712596029:0;exa -a
: 1712596134:0;ln -sfv "$XDG_CONFIG_HOME/git/template/commit-template.txt" "$XDG_CONFIG_HOME/.git/commit-template.txt"
: 1712596169:0;ln -sfv "$XDG_CONFIG_HOME/git/template/commit-template.txt" "$REPO_DIR/.git/commit-template.txt"
: 1712596175:0;exa -a
: 1712596215:0;ln -sfv "$XDG_CONFIG_HOME/git/template/commit-template.txt" "$REPO_DIR/.git/commit-template.txt"
: 1712596295:0;ln -sfv /Users/morimotosuguru/repos/github.com/sugurumorimoto/dotfiles/config/git/template/commit-template.txt .git/
